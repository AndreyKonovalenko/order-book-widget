import { describe, expect, test } from "@jest/globals";
import { manageOrderBook } from "./utils";

export const bids = [
  ["24551.89000000", "0.00079000"],
  ["24551.88000000", "0.08636000"],
  ["24551.85000000", "0.01333000"],
  ["24551.75000000", "0.00200000"],
  ["24551.74000000", "0.78974000"],
  ["24551.70000000", "0.00070000"],
  ["24551.69000000", "0.00100000"],
  ["24551.67000000", "0.00719000"],
  ["24551.66000000", "0.01359000"],
  ["24551.64000000", "0.41535000"],
];
export const asks = [
  ["24552.43000000", "0.05263000"],
  ["24552.54000000", "0.00070000"],
  ["24552.58000000", "0.00100000"],
  ["24552.60000000", "0.07464000"],
  ["24552.61000000", "0.06860000"],
  ["24552.65000000", "0.01942000"],
  ["24552.67000000", "0.06911000"],
  ["24552.68000000", "0.00065000"],
  ["24552.76000000", "0.01358000"],
  ["24552.80000000", "0.12871000"],
];

describe("Removing price level logic", () => {
  test("bids/asks price level exists, quantity set to 0", () => {
    expect(
      manageOrderBook(bids, [["24551.89000000", "0.00000000"]], "bids")
    ).toEqual([
      ["24551.88000000", "0.08636000"],
      ["24551.85000000", "0.01333000"],
      ["24551.75000000", "0.00200000"],
      ["24551.74000000", "0.78974000"],
      ["24551.70000000", "0.00070000"],
      ["24551.69000000", "0.00100000"],
      ["24551.67000000", "0.00719000"],
      ["24551.66000000", "0.01359000"],
      ["24551.64000000", "0.41535000"],
    ]);
    expect(
      manageOrderBook(asks, [["24552.54000000", "0.00000000"]], "asks")
    ).toEqual([
      ["24552.43000000", "0.05263000"],
      ["24552.58000000", "0.00100000"],
      ["24552.60000000", "0.07464000"],
      ["24552.61000000", "0.06860000"],
      ["24552.65000000", "0.01942000"],
      ["24552.67000000", "0.06911000"],
      ["24552.68000000", "0.00065000"],
      ["24552.76000000", "0.01358000"],
      ["24552.80000000", "0.12871000"],
    ]);
  });
});
describe("Update price level with new quantity logic", () => {
  test("bids/asks price level exists, different quantity", () => {
    expect(
      manageOrderBook(
        bids,
        [
          ["24551.85000000", "0.01733000"],
          ["24551.66000000", "0.01358000"],
        ],
        "bids"
      )
    ).toEqual([
      ["24551.89000000", "0.00079000"],
      ["24551.88000000", "0.08636000"],
      ["24551.85000000", "0.01733000"],
      ["24551.75000000", "0.00200000"],
      ["24551.74000000", "0.78974000"],
      ["24551.70000000", "0.00070000"],
      ["24551.69000000", "0.00100000"],
      ["24551.67000000", "0.00719000"],
      ["24551.66000000", "0.01358000"],
      ["24551.64000000", "0.41535000"],
    ]);

    expect(
      manageOrderBook(
        asks,
        [
          ["24552.43000000", "0.05273000"],
          ["24552.80000000", "0.82871000"],
        ],
        "asks"
      )
    ).toEqual([
      ["24552.43000000", "0.05273000"],
      ["24552.54000000", "0.00070000"],
      ["24552.58000000", "0.00100000"],
      ["24552.60000000", "0.07464000"],
      ["24552.61000000", "0.06860000"],
      ["24552.65000000", "0.01942000"],
      ["24552.67000000", "0.06911000"],
      ["24552.68000000", "0.00065000"],
      ["24552.76000000", "0.01358000"],
      ["24552.80000000", "0.82871000"],
    ]);
  });
});
describe("Add new price level to list logic", () => {
  test("new price level, add to list", () => {
    expect(
      manageOrderBook(
        bids,
        [
          ["24551.86000000", "0.01033000"],
          ["24552.00000000", "0.00079000"],
        ],
        "bids"
      )
    ).toEqual([
      ["24552.00000000", "0.00079000"],
      ["24551.89000000", "0.00079000"],
      ["24551.88000000", "0.08636000"],
      ["24551.86000000", "0.01033000"],
      ["24551.85000000", "0.01333000"],
      ["24551.75000000", "0.00200000"],
      ["24551.74000000", "0.78974000"],
      ["24551.70000000", "0.00070000"],
      ["24551.69000000", "0.00100000"],
      ["24551.67000000", "0.00719000"],
      ["24551.66000000", "0.01359000"],
      ["24551.64000000", "0.41535000"],
    ]);
    expect(
      manageOrderBook(
        asks,
        [
          ["24552.56000000", "0.00134000"],
          ["24553.00000000", "0.00079000"],
        ],
        "asks"
      )
    ).toEqual([
      ["24552.43000000", "0.05263000"],
      ["24552.54000000", "0.00070000"],
      ["24552.56000000", "0.00134000"],
      ["24552.58000000", "0.00100000"],
      ["24552.60000000", "0.07464000"],
      ["24552.61000000", "0.06860000"],
      ["24552.65000000", "0.01942000"],
      ["24552.67000000", "0.06911000"],
      ["24552.68000000", "0.00065000"],
      ["24552.76000000", "0.01358000"],
      ["24552.80000000", "0.12871000"],
      ["24553.00000000", "0.00079000"],
    ]);
  });
});

describe("Full list logic", () => {
  test("All cases", () => {
    expect(
      manageOrderBook(
        bids,
        [
          ["24551.86000000", "0.01033000"],
          ["24556.00000000", "0.00000000"],
          ["24551.66000000", "0.00000000"],
          ["24551.75000000", "0.00700000"],
        ],
        "bids"
      )
    ).toEqual([
      ["24551.89000000", "0.00079000"],
      ["24551.88000000", "0.08636000"],
      ["24551.86000000", "0.01033000"],
      ["24551.85000000", "0.01333000"],
      ["24551.75000000", "0.00700000"],
      ["24551.74000000", "0.78974000"],
      ["24551.70000000", "0.00070000"],
      ["24551.69000000", "0.00100000"],
      ["24551.67000000", "0.00719000"],
      ["24551.64000000", "0.41535000"],
    ]);
    expect(
      manageOrderBook(
        asks,
        [
          ["24552.54000000", "0.00270000"],
          ["24553.00000000", "0.00079000"],
          ["24552.60000000", "0.00000000"],
          ["24555.60000000", "0.00000000"],
        ],
        "asks"
      )
    ).toEqual([
      ["24552.43000000", "0.05263000"],
      ["24552.54000000", "0.00270000"],
      ["24552.58000000", "0.00100000"],
      ["24552.61000000", "0.06860000"],
      ["24552.65000000", "0.01942000"],
      ["24552.67000000", "0.06911000"],
      ["24552.68000000", "0.00065000"],
      ["24552.76000000", "0.01358000"],
      ["24552.80000000", "0.12871000"],
      ["24553.00000000", "0.00079000"],
    ]);
  });
});
